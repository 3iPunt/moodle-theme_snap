define(["jquery","core/log"],function(a,b){return{init:function(c){var d,e=[],f=!1,g=a("#snap-move-message"),h=function(c,d,e,g){if(f)return void b.debug("Skipping ajax request, one already in progress");i(a("#snap-move-message .snap-move-message-title")),c.sesskey=M.cfg.sesskey,c.courseId=M.theme_snap.courseid,c.field="move",b.debug("Making course/rest.php request",c);var h=a.ajax({type:"POST",async:!0,data:c,url:M.cfg.wwwroot+M.theme_snap.courseconfig.ajaxurl});h.done(function(a){a.error?(b.debug("Ajax request fail"),l()):(b.debug("Ajax request successful"),e&&e(),g&&u())}),h.fail(function(){l()}),g&&h.complete(function(){f=!1,a("#snap-move-message-title .spinner-three-quarters").remove()})},i=function(b,c){if(0===a(b).find(".loadingstat").length){var d=c?" spinner-dark":"";a(b).append('<div class="loadingstat spinner-three-quarters'+d+'">'+M.util.get_string("loading","theme_snap")+"</div>")}},j=function(b,c,d){b.preventDefault();var e=M.cfg.wwwroot+"/course/rest.php",f=a(a(c).parents(".snap-asset")[0]),g=f.attr("id").replace("module-","");i(a(f).find(".snap-meta"),!0);var h=M.theme_snap.courseid;a.ajax({type:"POST",async:!0,url:e,dataType:"html",complete:function(){f.find(".snap-meta .loadingstat").remove()},error:function(a,b,c){alert("Failed to hide/show asset")},success:function(a){d?f.removeClass("draft"):f.addClass("draft")},data:{id:g,"class":"resource",field:"visible",sesskey:M.cfg.sesskey,value:d?1:0,courseId:h}})},k=function(c){var f={};b.debug("Move objects",e),f["class"]="resource",p(),d=e.shift(),f.id=Number(d.id.replace("module-","")),c&&!a(c).hasClass("snap-drop")?f.beforeId=Number(a(c)[0].id.replace("module-","")):f.beforeId=0,"page-site-index"===document.body.id?f.sectionId=1:c?f.sectionId=Number(a(c).parents("li.section.main")[0].id.replace("section-","")):f.sectionId=Number(a(d).parents("li.section.main")[0].id.replace("section-","")),e.length>0?h(f,c,function(){a(c).before(a(d)),k(c)},!1):h(f,c,function(){a(c).before(a(d))},!0)},l=function(){a(".snap-move-notice").addClass("movefail"),a(".snap-move-notice .three-quarters").remove();var b=a(d).find(".instancename").html();a("#snap-move-message h5").html(M.util.get_string("movefailed","theme_snap",b)),window.setTimeout(function(){u(!1)},2e3)},m=function(){a(document).on("click",".snap-asset-actions .js_snap_hide",function(a){j(a,this,!1)}),a(document).on("click",".snap-asset-actions .js_snap_show",function(a){j(a,this,!0)}),a(document).on("click",".snap-asset-actions .js_snap_duplicate",function(b){b.preventDefault();var c=a(a(this).parents(".snap-asset")[0]),d=c.attr("id").replace("module-","");i(a(c).find(".snap-meta"),!0);var e=M.theme_snap.courseid,f=M.cfg.wwwroot+"/course/rest.php";a.ajax({type:"POST",async:!0,url:f,dataType:"json",complete:function(){c.find(".snap-meta .loadingstat").remove()},error:function(a,b,c){alert("Failed to duplicate")},success:function(b){a(b.fullcontent).insertAfter(c)},data:{"class":"resource",field:"duplicate",id:d,sr:0,sesskey:M.cfg.sesskey,courseId:e}})})},n=function(){a("#region-main").on("click",".snap-section-editing.actions .snap-move",function(c){c.stopPropagation(),c.preventDefault(),a("body").addClass("snap-move-inprogress");var d=a(this).data("id");b.debug("Section is",d);var f=a("#section-"+d),h=f.find(".sectionname").text();b.debug("Moving this section",h),e=[f],a(".section-moving").removeClass("section-moving"),f.addClass("section-moving"),a("a[href$=#section-"+d+"]").parent("li").addClass("section-moving"),a("body").addClass("snap-move-section");var i=M.util.get_string("moving","theme_snap",h);g.find(".snap-move-message-title").html(i),g.focus(),a(".section-drop").each(function(){var b=M.util.get_string("movingdropsectionhelp","theme_snap",{moving:h,before:a(this).data("title")});a(this).html(b)}),a("#snap-move-message p.sr-only").html(M.util.get_string("movingstartedhelp","theme_snap",h))})},o=function(){"page-site-index"===document.body.id?a("#region-main .sitetopic ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>"):a("li.section .content ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>")},p=function(){if(1===e.length){var b=a(e[0]).find(".snap-asset-link .instancename").html();b=b||M.str.label.pluginname;var c=M.util.get_string("moving","theme_snap",b);g.find(".snap-move-message-title").html(c)}else g.find(".snap-move-message-title").html(M.util.get_string("movingcount","theme_snap",e.length));g.focus()},q=function(a){var b=e.indexOf(a);b>-1&&e.splice(b,1),p()},r=function(){a("#region-main").on("change",".js-snap-asset-move",function(c){c.stopPropagation();var d=a(this).parents(".snap-asset")[0],f=a(d).parents("ul.section")[0],g=a(f).find("li.snap-drop.asset-drop");if(a(f).append(g),0===e.length){var h=a(d).find(".snap-asset-link .instancename").html();b.debug("Moving this asset",h);var i=a(d).attr("class"),j=/(?=snap-mime)([a-z0-9\-]*)/,k=j.exec(i),i="";k&&(i=k.join(" ")),b.debug("Moving this class",i),a(d).addClass("asset-moving"),a(d).find(".js-snap-asset-move").prop("checked","checked"),a("body").addClass("snap-move-inprogress"),a("body").addClass("snap-move-asset")}a(this).prop("checked")?(e.push(d),a(d).addClass("asset-moving")):(q(d),a(d).removeClass("asset-moving"),0===e.length&&u()),p()})},s=function(){a(document).on("click",".snap-move-note, .snap-drop",function(c){if(b.debug("Snap drop clicked",c),e)if(c.stopPropagation(),c.preventDefault(),a("body").hasClass("snap-move-section"))t(this);else{var d;d=a(this).hasClass("snap-drop")?this:a(this).closest(".snap-asset"),k(d)}})},t=function(b){var c=a(b).data("id"),d=a("#section-"+c),f=a(e[0]).attr("id").replace("section-","");c>f&&(c-=1);var g={"class":"section",id:f,value:c};h(g,d,function(){var a=g.value;location.href=location.href.replace(location.hash,"")+"#section-"+a,location.reload(!0)},!0)},u=function(){a("body").removeClass("snap-move-inprogress"),a("body").removeClass("snap-move-section"),a("body").removeClass("snap-move-asset"),a(".section-moving").removeClass("section-moving"),a(".asset-moving").removeClass("asset-moving"),a(".js-snap-asset-move").removeAttr("checked"),e=[]},v=function(){a(".snap-move-cancel").click(function(a){a.preventDefault(),u()})},w=function(){M.course&&M.course.resource_toolbox&&(M.course.resource_toolbox.handle_resource_dim=function(a,b,c){return"hide"===c?0:1})},x=function(){n(),r(),v(),s(),m(),o(),a("body").addClass("snap-course-listening")},y=function(){c&&(a("#region-main").append(c),g=a("#snap-move-message")),x(),w()};y()}}});