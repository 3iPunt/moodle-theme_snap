define(["jquery","core/log","core/ajax","core/notification"],function(a,b,c,d){var e=function(b,c){var d=M.util.get_string("close","theme_snap");a(b).length||a("#snap-coverimagecontrol").after('<div id="'+b+'" class="alert alert-warning" role="alert">'+c+'<button type="button" class="close" data-dismiss="alert" aria-label="'+d+'"><span aria-hidden="true">&times;</span></button></div>')},f=function(a){var b=Math.floor(Math.log(a)/Math.log(1024));return 1*(a/Math.pow(1024,b)).toFixed(2)+" "+["B","kB","MB","GB","TB"][b]},g=function(b,g){a("#page-header").data("servercoverfile",a("#page-header").css("background-image"));var h,i;a("#changecoverimage").click(function(b){b.preventDefault(),a(this).removeClass("state-visible"),a('label[for="snap-coverfiles"]').addClass("state-visible")});var j=function(){a("#snap-alert-cover-image-size").remove(),a("#snap-alert-cover-image-bytes").remove(),a('label[for="snap-coverfiles"] .loadingstat').remove(),a("#snap-changecoverimageconfirmation").removeClass("state-visible"),a('label[for="snap-coverfiles"]').addClass("state-visible"),a("#snap-coverfiles").val("")},k=function(){a("#snap-alert-cover-image-upload-failed").remove(),a("#snap-changecoverimageconfirmation").removeClass("disabled"),a('label[for="snap-coverfiles"]').removeClass("state-visible"),a("#snap-changecoverimageconfirmation").addClass("state-visible"),a("body").removeClass("cover-image-change")};a("#snap-coverfiles").on("change",function(b){a("body").addClass("cover-image-change");var c=b.target.files;if(c.length&&(h=c[0],h.type.match("image.*"))){var d=new FileReader;a('label[for="snap-coverfiles"]').append('<span class="loadingstat spinner-three-quarters">'+M.util.get_string("loading","theme_snap")+"</span>"),d.onload=function(b){return function(c){i=c.target.result,a(".path-course-view #page-header").addClass("mast-image");var d=a("<img />");d=d.get(0),d.src=i,d.width<1024?e("snap-alert-cover-image-size",M.util.get_string("error:coverimageresolutionlow","theme_snap")):a("#snap-alert-cover-image-size").remove();var h=g;if(b.size>h){j();var l=f(h),m=M.util.get_string("error:coverimageexceedsmaxbytes","theme_snap",l);return void e("snap-alert-cover-image-bytes",m)}a("#snap-alert-cover-image-bytes").remove(),a("#page-header").css("background-image","url("+i+")"),a("#page-header").data("localcoverfile",b.name),k()}}(h),d.readAsDataURL(h)}}),a("#snap-changecoverimageconfirmation .ok").click(function(){if(!a(this).parent().hasClass("disabled")){a("#snap-alert-cover-image-size").remove(),a("#snap-alert-cover-image-bytes").remove(),a("#snap-changecoverimageconfirmation .ok").append('<span class="loadingstat spinner-three-quarters">'+M.util.get_string("loading","theme_snap")+"</span>"),a("#snap-changecoverimageconfirmation").addClass("disabled");var f=i.split("base64,")[1];c.call([{methodname:"theme_snap_cover_image",args:{imagefilename:h.name,imagedata:f,courseshortname:b},done:function(b){j(),a("#snap-changecoverimageconfirmation .ok .loadingstat").remove(),!b.success&&b.warning&&e("snap-alert-cover-image-upload-failed",b.warning)},fail:function(b){j(),a("#snap-changecoverimageconfirmation .ok .loadingstat").remove(),d.exception(b)}}],!0,!0)}}),a("#snap-changecoverimageconfirmation .cancel").click(function(){a(this).parent().hasClass("disabled")||(a("#page-header").css("background-image",a("#page-header").data("servercoverfile")),j())}),a("#snap-coverimagecontrol").addClass("snap-js-enabled")};return g});