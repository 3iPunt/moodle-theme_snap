define(["jquery","core/log","theme_snap/pm_course_cards"],function(a,b,c){return new function(){var c=this;this.update=function(){var c=!0;if("object"==typeof localStorage)try{localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage")}catch(d){c=!1}a("#primary-nav").focus(),a("#page, #moodle-footer, #js-personal-menu-trigger, #logo, .skiplinks").hide(0);var e=function(d){var e=a("#snap-personal-menu-"+d);if(a(e).length){var f=M.cfg.sesskey+"personal-menu-"+d;try{if(window.sessionStorage[f]){b.info("using locally stored "+d);var g=window.sessionStorage[f];a(e).html(g)}b.info("fetching "+d),a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_"+d+"&contextid="+M.cfg.context,success:function(g){b.info("fetched "+d),c&&(window.sessionStorage[f]=g.html),a(e).attr("data-content-loaded","1"),a(e).html(g.html)}})}catch(h){sessionStorage.clear(),b.error(h)}}};e("deadlines"),e("graded"),e("grading"),e("messages"),e("forumposts");var f=[],g=M.cfg.sesskey+"courseinfo";if(a(".courseinfo .dynamicinfo").each(function(){f.push(a(this).attr("data-courseid"))}),f.length>0){var h=function(c){for(var d in c){var e=c[d];b.info("applying course data for courseid "+e.courseid);var f=e.progress.progresshtml;e.feedback&&e.feedback.feedbackhtml&&(f+=e.feedback.feedbackhtml),a('.courseinfo [data-courseid="'+e.courseid+'"]').html(f)}};if(window.sessionStorage[g]){var i=JSON.parse(window.sessionStorage[g]);h(i)}var j="courseids="+f.join(",");b.info("fetching course data"),a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_courseinfo&contextid="+M.cfg.context,data:j,success:function(a){a.info?(b.info("fetched coursedata",a.info),c&&(window.sessionStorage[g]=JSON.stringify(a.info)),h(a.info)):b.warn("fetched coursedata with error: JSON data object is missing info property",a)}})}};var d=function(){a(document).on("click",".js-personal-menu-trigger",function(b){a("body").toggleClass("snap-fixy-open"),a(".snap-fixy-open #primary-nav").is(":visible")&&c.update(),b.preventDefault()}),a(document).on("click","#fixy-mobile-menu a",function(b){var c=this.getAttribute("href"),d=a("#fixy-content section"),e=a(d).outerWidth(),f=(d.length*e,a(c)),g=a("#fixy-content section > div").index(f),h=e*g;"#fixy-my-courses"==c&&(h=0);var i=a(c).outerHeight()+100,j=a(window).height();j>i&&(i=j),a("#fixy-content").animate({left:"-"+h+"px",height:i+"px"},"fast","swing",function(){}),b.preventDefault()}),a(document).on("click","#fixy-close",function(){a("#page, #moodle-footer, #js-personal-menu-trigger, #logo, .skiplinks").css("display","")})};d()}});