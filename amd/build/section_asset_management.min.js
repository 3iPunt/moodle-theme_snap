define(["jquery","core/log","core/ajax","core/templates","core/notification","theme_snap/util"],function(a,b,c,d,e,f){return{init:function(g){var h,i=[],j=!1,k=a("#snap-move-message"),l=function(){a("body").removeClass("snap-move-inprogress"),a("body").removeClass("snap-move-section"),a("body").removeClass("snap-move-asset"),a(".section-moving").removeClass("section-moving"),a(".asset-moving").removeClass("asset-moving"),a(".js-snap-asset-move").removeAttr("checked"),i=[]},m=function(){a(".snap-move-notice").addClass("movefail"),a(".snap-move-notice .three-quarters").remove();var b=a(h).find(".instancename").html();a("#snap-move-message h5").html(M.util.get_string("movefailed","theme_snap",b)),window.setTimeout(function(){l(!1)},2e3)},n=function(){if(1===i.length){var b=a(i[0]).find(".snap-asset-link .instancename").html();b=b||M.str.label.pluginname;var c=M.util.get_string("moving","theme_snap",b);k.find(".snap-move-message-title").html(c)}else k.find(".snap-move-message-title").html(M.util.get_string("movingcount","theme_snap",i.length));k.focus()},o=function(a){var b=i.indexOf(a);b>-1&&i.splice(b,1),n()},p=function(b,c){if(0===a(b).find(".loadingstat").length){var d=c?" spinner-dark":"";a(b).append('<div class="loadingstat spinner-three-quarters'+d+'">'+M.util.get_string("loading","theme_snap")+"</div>")}},q=function(c,d,e){if(j)return void b.debug("Skipping ajax request, one already in progress");p(a("#snap-move-message .snap-move-message-title")),c.sesskey=M.cfg.sesskey,c.courseId=g.courseConfig.id,c.field="move",b.debug("Making course/rest.php request",c);var f=a.ajax({type:"POST",async:!0,data:c,url:M.cfg.wwwroot+g.courseConfig.ajaxurl});f.done(function(a){a.error?(b.debug("Ajax request fail"),m()):(b.debug("Ajax request successful"),d&&d(),e&&"resource"===c["class"]&&l())}),f.fail(function(){m()}),e&&f.complete(function(){j=!1,a("#snap-move-message-title .spinner-three-quarters").remove()})},r=function(b,c,d){b.preventDefault();var f=M.cfg.wwwroot+"/course/rest.php",h=a(a(c).parents(".snap-asset")[0]),i=h.attr("id").replace("module-","");p(a(h).find(".snap-meta"),!0);var j=g.courseConfig.id;a.ajax({type:"POST",async:!0,url:f,dataType:"html",complete:function(){h.find(".snap-meta .loadingstat").remove()},error:function(){var a=M.util.get_string("error:failedtochangeassetvisibility","theme_snap");e.alert(null,a,M.util.get_string("ok","moodle"))},success:function(){d?h.removeClass("draft"):h.addClass("draft")},data:{id:i,"class":"resource",field:"visible",sesskey:M.cfg.sesskey,value:d?1:0,courseId:j}})},s=function(c){var d={};b.debug("Move objects",i),d["class"]="resource",n(),h=i.shift(),d.id=Number(h.id.replace("module-","")),c&&!a(c).hasClass("snap-drop")?d.beforeId=Number(a(c)[0].id.replace("module-","")):d.beforeId=0,"page-site-index"===document.body.id?d.sectionId=1:c?d.sectionId=Number(a(c).parents("li.section.main")[0].id.replace("section-","")):d.sectionId=Number(a(h).parents("li.section.main")[0].id.replace("section-","")),i.length>0?q(d,function(){a(c).before(a(h)),s(c)},!1):q(d,function(){a(c).before(a(h))},!0)},t=function(b){var f=parseInt(a(b).parents("li.section")[0].id.replace("section-","")),h=parseInt(a(i[0]).attr("id").replace("section-","")),j=f>h?f-1:f,k={"class":"section",id:h,value:j};q(k,function(){c.call([{methodname:"theme_snap_course_toc_chapters",args:{courseshortname:g.courseConfig.shortname},done:function(b){d.render("theme_snap/course_toc_chapters",b.chapters).done(function(b){a("#chapters").replaceWith(b),a("#section-"+f).before(a("#section-"+h)),a.each(a("ul.topics li.section"),function(b,c){a(c).attr("id","section-"+b)}),location.hash="section-"+j,g.showSection(),l()})},fail:function(a){e.exception(a),l()}}],!0,!0)},!0)},u=function(){a(document).on("click",".snap-asset-actions .js_snap_hide",function(a){r(a,this,!1)}),a(document).on("click",".snap-asset-actions .js_snap_show",function(a){r(a,this,!0)}),a(document).on("click",".snap-asset-actions .js_snap_duplicate",function(b){b.preventDefault();var c=a(a(this).parents(".snap-asset")[0]),d=c.attr("id").replace("module-","");p(a(c).find(".snap-meta"),!0);var f=g.courseConfig.id,h=M.cfg.wwwroot+"/course/rest.php";a.ajax({type:"POST",async:!0,url:h,dataType:"json",complete:function(){c.find(".snap-meta .loadingstat").remove()},error:function(){var a=M.util.get_string("error:failedtoduplicateasset","theme_snap");e.alert(null,a,M.util.get_string("ok","moodle"))},success:function(b){a(b.fullcontent).insertAfter(c)},data:{"class":"resource",field:"duplicate",id:d,sr:0,sesskey:M.cfg.sesskey,courseId:f}})})},v=function(a,b){b.done&&"function"==typeof b.done&&a.done(function(a){b.done(a),b.always&&"function"==typeof b.always&&b.always(a)}),b.fail&&"function"==typeof b.fail&&a.fail(function(a){b.fail(a),b.always&&"function"==typeof b.always&&b.always(a)})},w=function(f,h){a("#region-main").on("click",".snap-section-editing.actions .snap-"+f,function(i){i.stopPropagation(),i.preventDefault();var k=function(a){this.message="Invalid section action: "+a,this.name="invalidActionException"},l=["visibility","highlight"];if(-1===l.indexOf(f))throw new k(f);if(j)return void b.debug("Skipping ajax request, one already in progress");j=!0;var m="visibility"===f?"snap-show":"snap-marker",n=a(this).hasClass(m)?1:0,o=a(this).parents("li.section")[0].id.replace("section-",""),q="#section-"+o+" .snap-section-editing",r=q+" .snap-"+f;p(q,!0);var s=c.call([{methodname:"theme_snap_course_sections",args:{courseshortname:g.courseConfig.shortname,action:f,sectionnumber:o,value:n}}],!0,!0);v(s[0],{done:function(b){v(d.render("theme_snap/course_action_section",b.actionmodel),{done:function(c){a(r).replaceWith(c),a(r).focus(),v(d.render("theme_snap/course_toc",b.toc),{done:function(b){a("#course-toc").replaceWith(b),h&&"function"==typeof h&&h(o,n)},always:function(){a(q+" .loadingstat").remove()}})},fail:function(){a(q+" .loadingstat").remove()}})},fail:function(){var b;b="visibility"===f?M.util.get_string("error:failedtochangesectionvisibility","theme_snap"):M.util.get_string("error:failedtohighlightsection","theme_snap"),e.alert(null,b,M.util.get_string("ok","moodle")),a(q+" .loadingstat").remove()},always:function(){j=!1}})})},x=function(){w("highlight")},y=function(){var b=function(b,c){0===c?a("#section-"+b).addClass("hidden"):a("#section-"+b).removeClass("hidden")};w("visibility",b)},z=function(){a("#region-main").on("click",".snap-section-editing.actions .snap-move",function(c){c.stopPropagation(),c.preventDefault(),a("body").addClass("snap-move-inprogress");var d=a(this).parents("li.section")[0].id.replace("section-","");b.debug("Section is",d);var e=a("#section-"+d),f=e.find(".sectionname").text();b.debug("Moving this section",f),i=[e],a(".section-moving").removeClass("section-moving"),e.addClass("section-moving"),a("a[href$=#section-"+d+"]").parent("li").addClass("section-moving"),a("body").addClass("snap-move-section");var g=M.util.get_string("moving","theme_snap",f);k.find(".snap-move-message-title").html(g),k.focus(),a(".section-drop").each(function(){var b=M.util.get_string("movingdropsectionhelp","theme_snap",{moving:f,before:a(this).data("title")});a(this).html(b)}),a("#snap-move-message p.sr-only").html(M.util.get_string("movingstartedhelp","theme_snap",f))})},A=function(){"page-site-index"===document.body.id?a("#region-main .sitetopic ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>"):a("li.section .content ul.section").append('<li class="snap-drop asset-drop"><div class="asset-wrapper"><a href="#">'+M.util.get_string("movehere","theme_snap")+"</a></div></li>")},B=function(){a("#region-main").on("change",".js-snap-asset-move",function(c){c.stopPropagation();var d=a(this).parents(".snap-asset")[0],e=a(d).parents("ul.section")[0],f=a(e).find("li.snap-drop.asset-drop");if(a(e).append(f),0===i.length){var g=a(d).find(".snap-asset-link .instancename").html();b.debug("Moving this asset",g);var h=a(d).attr("class"),j=/(?=snap-mime)([a-z0-9\-]*)/,k=j.exec(h);h="",k&&(h=k.join(" ")),b.debug("Moving this class",h),a(d).addClass("asset-moving"),a(d).find(".js-snap-asset-move").prop("checked","checked"),a("body").addClass("snap-move-inprogress"),a("body").addClass("snap-move-asset")}a(this).prop("checked")?(i.push(d),a(d).addClass("asset-moving")):(o(d),a(d).removeClass("asset-moving"),0===i.length&&l()),n()})},C=function(){a(document).on("click",".snap-move-note, .snap-drop",function(c){if(b.debug("Snap drop clicked",c),i)if(c.stopPropagation(),c.preventDefault(),a("body").hasClass("snap-move-section"))t(this);else{var d;d=a(this).hasClass("snap-drop")?this:a(this).closest(".snap-asset"),s(d)}})},D=function(){a(".snap-move-cancel").click(function(a){a.preventDefault(),l()})},E=function(){z(),y(),x(),B(),D(),C(),u(),A(),a("body").addClass("snap-course-listening")},F=function(){M.course&&M.course.resource_toolbox&&(M.course.resource_toolbox.handle_resource_dim=function(a,b,c){return"hide"===c?0:1})},G=function(){a("#snap-move-message").length||d.render("theme_snap/snap_move_notice",{}).done(function(b){a("#region-main").append(b),k=a("#snap-move-message")}),E(),f.whenTrue(function(){return M.course&&M.course.init_section_toolbox},function(){F()},!0)};G()}}});