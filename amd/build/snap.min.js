define(["jquery","snapBootstrap","core/log","theme_snap/course_favorites"],function($,bsjq,log,courseFavorites){"use strict";$=bsjq;var loggingenabled=!1,navheight=$("#mr-nav").outerHeight(),resizestamp=null;loggingenabled?log.enableAll(!0):log.disableAll(!0);var lightbox=function(a,b){var c=$("#snap-light-box");return 0===c.length&&($(a).append('<div id="snap-light-box" tabindex="-1"><div id="snap-light-box-content"></div><a id="snap-light-box-close" class="pull-right snap-action-icon" href="#"><i class="icon icon-close"></i><small>Close</small></a></div>'),$("#snap-light-box-close").click(function(a){a.preventDefault(),a.stopPropagation(),lightboxclose(),"function"==typeof b&&b()}),c=$("#snap-light-box")),c},lightboxclose=function(){var a=lightbox();a.remove()},lightboxopen=function(a,b,c){var b=b?b:$("body"),d=lightbox(b,c);if(a){var e=$("#snap-light-box-content");e.html(""),e.append(a)}d.addClass("state-visible")},movePHPErrorsToHeader=function(){var a=$(".xdebug-error");if(a.length)for(var b=0;b<a.length;b++){var c=a[b],d=c.parentNode,e=$(d).prev("br");$(e).remove()}var f=$(".xdebug-error, .php-debug, .debuggingmessage");if(f.length){$(f).addClass("php-debug-footer");var g=$('<div id="footer-error-cont"><h3>'+M.util.get_string("debugerrors","theme_snap")+"</h3><hr></div>");$("#page-footer").append(g),$("#footer-error-cont").append(f),$(".php-debug-footer").after($("<hr>")),$("#mr-nav").addClass("errors-found");var h=$('<a class="footer-error-link btn btn-danger" href="#footer-error-cont">'+M.util.get_string("problemsfound","theme_snap")+' <span class="badge">'+f.length+"</span></a>");$("#page-header").append(h)}},onCoursePage=function(){return 0===$("body").attr("id").indexOf("page-course-view-")},applyBlockHash=function(){if(onCoursePage()&&$(".block_adminblock form").each(function(){$(this).attr("action",$(this).attr("action")+"#coursetools")}),""===location.hash){var a=getURLParams(location.href);onCoursePage()&&"undefined"!=typeof a.time&&(location.hash="coursetools",$(".block_calendar_month")&&scrollToElement($(".block_calendar_month")));var b=["body.path-blocks-collect #notice form"],c=["bui_deleteid","bui_editid"];for(var d in c){var e=c[d];if("undefined"!=typeof a[e]){b.push("#notice form");break}}$(b.join(", ")).each(function(){var a=$(this).attr("action");-1===a.indexOf("#")&&a.indexOf("/course/view.php")>-1&&$(this).attr("action",$(this).attr("action")+"#coursetools")})}},applyResponsiveVideo=function(){$(".mediaplugin object, .mediaplugin embed, iframe").not("[data-iframe-srcvideo='value']").each(function(){var a,b,c,d=this.tagName.toLowerCase();if("iframe"===d){var e=["youtube.com","youtu.be","vimeo.com","archive.org/embed","youtube-nocookie.com","embed.ted.com","embed-ssl.ted.com","kickstarter.com","video.html","simmons.tegrity.com","dailymotion.com"],f=!1;for(var g in e)if(this.src.indexOf(e[g])>-1){f=!0;break}if(this.setAttribute("data-iframe-srcvideo",f?"1":"0"),!f)return!0;$(this).parent().addClass("videoiframe")}c=this.getAttribute("data-aspect-ratio"),null===c&&(a=this.width||this.offsetWidth,a=parseInt(a),b=this.height||this.offsetHeight,b=parseInt(b),c=b/a,this.setAttribute("data-aspect-ratio",c)),"iframe"===d&&($(this).removeAttr("width"),$(this).removeAttr("height")),a=parseInt(this.offsetWidth);var h={height:a*c+"px"};$(this).css(h)})},setForumStrings=function(){$(".path-mod-forum tr.discussion td.topic.starter").attr("data-cellname",M.util.get_string("forumtopic","theme_snap")),$(".path-mod-forum tr.discussion td.picture:not('.group')").attr("data-cellname",M.util.get_string("forumauthor","theme_snap")),$(".path-mod-forum tr.discussion td.picture.group").attr("data-cellname",M.util.get_string("forumpicturegroup","theme_snap")),$(".path-mod-forum tr.discussion td.replies").attr("data-cellname",M.util.get_string("forumreplies","theme_snap")),$(".path-mod-forum tr.discussion td.lastpost").attr("data-cellname",M.util.get_string("forumlastpost","theme_snap"))},getURLParams=function(a){var b=a.split("?");if(b.length<2)return!1;var c=b[1];c=c.split("#")[0];for(var d=c.split("&"),e=[],f=0;f<d.length;f++){var g=d[f].split("="),h=g[0],i=g[1];e[h]=i}return e},tocSearchCourse=function(a){var b,c=window.navigator.userAgent;if(c.indexOf("MSIE ")||c.indexOf("Trident/"))var a=$("#toc-searchables").find("li").clone(!0);var d=$("#toc-search-input").val();if(d=processSearchString(d),0===d.length)$("#toc-search-results").html(""),$("#toc-search-input").removeClass("state-active");else{$("#toc-search-input").addClass("state-active");var e=[];for(b=0;b<a.length;b++){var f=a[b];processSearchString($(f).text()).indexOf(d)>-1&&e.push(f)}$("#toc-search-results").html(e)}},processSearchString=function(a){return a=a.trim().toLowerCase()},polyfills=function(){Modernizr.input.placeholder||$("input, textarea").placeholder()},updatePersonalMenu=function(){var a=!0;if("object"==typeof localStorage)try{localStorage.setItem("localStorage",1),localStorage.removeItem("localStorage")}catch(b){a=!1}$("#primary-nav").focus();var c=function(b){var c=$("#snap-personal-menu-"+b);if($(c).length){var d=M.cfg.sesskey+"personal-menu-"+b;try{if(window.sessionStorage[d]){log.info("using locally stored "+b);var e=window.sessionStorage[d];$(c).html(e)}log.info("fetching "+b),$.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_"+b+"&contextid="+M.cfg.context,success:function(e){log.info("fetched "+b),a&&(window.sessionStorage[d]=e.html),$(c).attr("data-content-loaded","1"),$(c).html(e.html)}})}catch(f){sessionStorage.clear(),log.error(f)}}};c("deadlines"),c("graded"),c("grading"),c("messages"),c("forumposts");var d=[],e=M.cfg.sesskey+"courseinfo";if($(".courseinfo .dynamicinfo").each(function(){d.push($(this).attr("data-courseid"))}),d.length>0){var f=function(a){for(var b in a){var c=a[b];log.info("applying course data for courseid "+c.courseid);var d=c.progress.progresshtml;c.feedback&&c.feedback.feedbackhtml&&(d+=c.feedback.feedbackhtml),$('.courseinfo [data-courseid="'+c.courseid+'"]').html(d)}};if(window.sessionStorage[e]){var g=JSON.parse(window.sessionStorage[e]);f(g)}var h="courseids="+d.join(",");log.info("fetching course data"),$.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_courseinfo&contextid="+M.cfg.context,data:h,success:function(b){b.info?(log.info("fetched coursedata",b.info),a&&(window.sessionStorage[e]=JSON.stringify(b.info)),f(b.info)):log.warn("fetched coursedata with error: JSON data object is missing info property",b)}})}},scrollToElement=function(a){if(a.length&&!(a.length>1)){var b=a.offset().top-navheight;$("html, body").animate({scrollTop:b},600)}},checkHashScrollToModule=function(){0===location.hash.indexOf("#module")&&scrollToModule(location.hash)},scrollToModule=function(a){$("#toc-search-results").html("");var b=$("#"+a.replace("#",""));scrollToElement(b);var c=$("#searchpin");c.length||(c=$('<i id="searchpin"></i>')),$(b).find(".instancename").prepend(c),$(b).attr("tabindex","-1").focus()},showSection=function(){if(onCoursePage()){if(!$(".format-folderview").length){$(".course-content .main, #moodle-blocks,#coursetools, #snap-add-new-section").removeClass("state-visible");var a=location.hash.split("&"),b=a[0],c=a[1]||null;"#coursetools"==b&&$("#moodle-blocks").addClass("state-visible"),null!==c?($(b).addClass("state-visible"),scrollToModule(c)):($(b).addClass("state-visible").focus(),window.scrollTo(0,0))}var d=$(".course-content .main, #coursetools, #snap-add-new-section").filter(":visible");d.length||($("#section-0").addClass("state-visible").focus(),window.scrollTo(0,0)),applyResponsiveVideo();var e=$(".main.state-visible, #coursetools.state-visible, #snap-add-new-section.state-visible").attr("id");$("#chapters li").removeClass("current"),$('#chapters a[href$="'+e+'"]').parent("li").addClass("current")}},bodyClasses=function(){var a=[];$("#notice.snap-continue-cancel").length&&a.push("hascontinuecancel"),$("body").addClass(a.join(" "))},updateModCompletion=function(a,b){a.find(".autocompletion").replaceWith(b)},revealPageMod=function(a,b){a.find(".pagemod-content").slideToggle("fast",function(){a.is(".state-expanded")?(a.attr("aria-expanded","true"),a.find(".pagemod-content").focus()):(a.attr("aria-expanded","false"),a.focus())}),b&&updateModCompletion(a,b),applyResponsiveVideo()},lightboxMedia=function(resourcemod){var appendto=$("body"),spinner='<div class="loadingstat three-quarters">'+Y.Escape.html(M.util.get_string("loading","theme_snap"))+"</div>";lightboxopen(spinner,appendto,function(){$(resourcemod).attr("tabindex","-1").focus(),$(resourcemod).removeAttr("tabindex")}),$.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_media&contextid="+$(resourcemod).data("modcontext"),success:function(data){lightboxopen(data.html,appendto),updateModCompletion($(resourcemod),data.completionhtml);var hasflowplayerscript=!1;if($("#snap-light-box script").each(function(){var script=$(this).text();script=script.replace(/^(?:\s*)\/\/<!\[CDATA\[/,"").replace(/\/\/\]\](?:\s*)$/,""),script.indexOf("M.util.add_video_player")>-1&&(hasflowplayerscript=!0,M.util.video_players=[]),eval(script)}),hasflowplayerscript){if(-1==M.cfg.jsrev)var jsurl=M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.13.js";else var jsurl=M.cfg.wwwroot+"/lib/javascript.php?jsfile=/lib/flowplayer/flowplayer-3.2.13.min.js&rev="+M.cfg.jsrev;$('head script[src="'+jsurl+'"]').remove(),"undefined"!=typeof flowplayer&&(flowplayer=void 0),M.util.load_flowplayer(),$('head script[src="'+jsurl+'"]').trigger("onreadystatechange")}window.setTimeout(function(){applyResponsiveVideo()},1e3),$("#snap-light-box").focus()}})},addListeners=function(){var a=["body:not(.editing):not(.format-folderview) .chapters a","body:not(.format-folderview) .section_footer a","body:not(.format-folderview) #toc-search-results a"];$(document).on("click",a.join(", "),function(a){var b=this.getAttribute("href");window.history&&window.history.pushState?(history.pushState(null,null,b),$(window).trigger("hashchange"),a.preventDefault()):location.hash=b});var b=location.hash;$(window).on("popstate hashchange",function(a){var c=location.hash;log.info("hashchange"),c!==b&&("#primary-nav"===location.hash?updatePersonalMenu():($("#page, #moodle-footer, #js-personal-menu-trigger, #logo, .skiplinks").css("display",""),onCoursePage()&&(log.info("show section",a.target),$(".format-folderview").length?checkHashScrollToModule():showSection()))),b=c});var c=document.querySelector("#mr-nav"),d=new Headroom(c,{tolerance:5,offset:100,classes:{initial:"headroom",pinned:"headroom--pinned",unpinned:"headroom--unpinned",top:"headroom--top",notTop:"headroom--not-top"}});$(".notloggedin").length||d.init();var e=$("#toc-searchables").find("li").clone(!0);$("#toc-search-input").keyup(function(){tocSearchCourse(e)}),$("#toc-search-input").keydown(function(a){var b=a.keyCode||a.which;9===b&&$("#toc-search-results a").last().blur(function(){$(this).off("blur"),$("#toc-search-input").val(""),$("#toc-search-results").html(""),$("#toc-search-input").removeClass("state-active")})}),$(document).on("click","#toc-search-results a",function(){$("#toc-search-input").val(""),$("#toc-search-results").html(""),$("#toc-search-input").removeClass("state-active")}),$(document).on("click",function(a){$(a.target).closest("#toc-search-input").length||($("#toc-search-input").val(""),$("#toc-search-results").html(""),$("#toc-search-input").removeClass("state-active"))}),$(document).on("click","[data-action=hide],[data-action=show]",function(){$(this).closest("li.activity").toggleClass("draft")}),$(document).on("click",".courseinfo[data-href]",function(a){var b=$(a.target),c="_self";$(b).closest("a").length||(window.open($(this).data("href"),c),a.preventDefault())}),$(document).on("click",".snap-resource",function(a){var b=$(a.target),c="_self",d=$(b).closest(".snap-resource").find(".snap-asset-link a"),e="";if(d.length>0&&(e=$(d).attr("href")),!$(b).closest("form, a, input, label").length){if($(this).hasClass("js-snap-media"))lightboxMedia(this);else{if(""===e)return;"_blank"===$(d).attr("target")&&(c="_blank"),window.open(e,c)}a.preventDefault()}}),$(document).on("click","#admin-menu-trigger, #toc-mobile-menu-toggle",function(a){var b=this.getAttribute("href");"admin-menu-trigger"==this.getAttribute("id")&&($(this).toggleClass("active"),$("#page").toggleClass("offcanvas")),$(b).attr("tabindex","0"),$(b).toggleClass("state-visible").focus(),a.preventDefault()}),$(document).on("click",".js-personal-menu-trigger",function(a){$("body").toggleClass("snap-fixy-open"),$(".snap-fixy-open #primary-nav").is(":visible")&&updatePersonalMenu(),a.preventDefault()}),$(document).on("click","#course-toc.state-visible a",function(a){$("#course-toc").removeClass("state-visible")}),$(document).on("click",".modtype_page .instancename,.pagemod-readmore,.pagemod-content .snap-action-icon",function(a){var b=$(this).closest(".modtype_page");scrollToElement(b);var c=b.hasClass("state-expanded");b.toggleClass("state-expanded");var d=b.find(".pagemod-readmore"),e=b.find(".pagemod-content");1==e.data("content-loaded")?(revealPageMod(b),c||$.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=read_page&contextid="+d.data("pagemodcontext"),success:function(a){updateModCompletion(b,a.completionhtml)}})):c?revealPageMod(b):(b.find(".contentafterlink").prepend('<div class="ajaxstatus alert alert-info">'+M.str.theme_snap.loading+"</div>"),$.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_page&contextid="+d.data("pagemodcontext"),success:function(a){e.prepend(a.html),e.data("content-loaded",1),b.find(".contentafterlink .ajaxstatus").remove(),revealPageMod(b,a.completionhtml)}})),a.preventDefault()}),$(document).on("click",".news-article .toggle",function(a){var b=$(this).closest(".news-article");scrollToElement(b),$(".news-article").not(b).removeClass("state-expanded"),$(".news-article-message").css("display","none"),b.toggleClass("state-expanded"),$(".state-expanded").find(".news-article-message").slideDown("fast",function(){b.is(".state-expanded")?(b.find(".news-article-message").focus(),b.attr("aria-expanded","true")):(b.focus(),b.attr("aria-expanded","false"))}),applyResponsiveVideo(),a.preventDefault()}),$(window).resize(function(){resizestamp=(new Date).getTime(),function(a){window.setTimeout(function(){log.info("checking "+a+" against "+resizestamp),a===resizestamp?(log.info("running resize hook functions"),applyResponsiveVideo()):log.info("skipping resize hook functions - timestamp has changed from "+a+" to "+resizestamp)},200)}(resizestamp)}),$(document).on("click","#js-toggle-hidden-courses",function(a){$("#fixy-hidden-courses").slideToggle("fast",function(){$("#fixy-hidden-courses").focus()}),a.preventDefault()}),$("#fixy-my-courses").on("click hover",".courseinfo-teachers-more",null,function(a){a.preventDefault();var b=$(this).html();b.indexOf("+")>-1?$(this).html(b.replace("+","-")):$(this).html(b.replace("-","+")),$(this).parents(".courseinfo").toggleClass("show-all")}),$(document).on("click","#fixy-mobile-menu a",function(a){var b=this.getAttribute("href"),c=$("#fixy-content section"),d=$(c).outerWidth(),e=(c.length*d,$(b)),f=$("#fixy-content section > div").index(e),g=d*f;"#fixy-my-courses"==b&&(g=0);var h=$(b).outerHeight()+100,i=$(window).height();i>h&&(h=i),$("#fixy-content").animate({left:"-"+g+"px",height:h+"px"},"fast","swing",function(){}),a.preventDefault()}),$(function(){var a=!1;"ontouchstart"in window?a=!0:window.navigator.msPointerEnabled&&(a=!0),a||$('[data-toggle="tooltip"]').tooltip()})};return{snapInit:function(a,b,c){M.theme_snap=M.theme_snap||{},M.theme_snap.courseid=a,M.theme_snap.courseconfig=c,M.cfg.context=b,$(document).ready(function(){if(movePHPErrorsToHeader(),polyfills(),setForumStrings(),addListeners(),applyBlockHash(),bodyClasses(),courseFavorites(),onCoursePage()&&showSection(),$("body").hasClass("snap-fixy-open")&&updatePersonalMenu(),$(".format-folderview").length&&checkHashScrollToModule(),$("#page-course-editsection.format-topics").length){var a=document.getElementById("id_usedefaultname"),b=document.getElementById("id_name");a.value="0",a.checked=!1,b.required="required",b.focus(),$("#id_name + span").css("display","none"),$("#id_cancel").on("click",function(a){$("#id_name").removeAttr("required"),$("#mform1").submit()})}if($(".format-folderview").length&&checkHashScrollToModule(),$("#page-mod-book-view").length){var c=getURLParams(location.href);$(".block_book_toc").append('<p><hr><a target="_blank" href="/mod/book/tool/print/index.php?id='+c.id+'">'+M.util.get_string("printbook","booktool_print")+"</a></p>")}var d=/^page-mod-.*-mod$/,e=d.test($("body").attr("id"))&&location.href.indexOf("modedit")>-1,f="page-course-edit"===$("body").attr("id"),g="page-course-editsection"===$("body").attr("id");if(e||f||g){var h=[":first","#page-course-edit #id_descriptionhdr","#id_contentsection","#id_general + #id_general","#id_content","#page-mod-choice-mod #id_optionhdr","#page-mod-assign-mod #id_availability","#page-mod-assign-mod #id_submissiontypes","#page-mod-workshop-mod #id_gradingsettings","#page-mod-choicegroup-mod #id_miscellaneoussettingshdr","#page-mod-choicegroup-mod #id_groups","#page-mod-scorm-mod #id_packagehdr"];h=h.join(),$("#mform1 > fieldset").not(h).wrapAll('<div class="snap-form-advanced col-md-4" />'),$(".snap-form-advanced").append($(".collapsible-actions"));for(var i=$("#mform1 fieldset:first"),j=$("#mform1 fieldset:first .fcontainer"),k=$("#mform1 > fieldset").not("#mform1 > fieldset:first"),l=0;l<k.length;l++){var m=$(k[l]).find(".fcontainer");$(j).append(m),$(k[l]).remove()}$(i).wrap('<div class="snap-form-required col-md-8" />');var n=$("#mform1 fieldset:first .fitem_feditor:not(.required)");if(e&&n){var o="page-mod-assign-mod"==$("body").attr("id"),p="page-mod-choice-mod"==$("body").attr("id"),q="page-mod-turnitintool-mod"==$("body").attr("id"),r="page-mod-workshop-mod"==$("body").attr("id");p||o||q||r||($(j).append(n),$(j).append($("#fitem_id_showdescription")))}var s=$("#mform1 #fgroup_id_buttonar");$(i).append(s)}$(window).on("load",function(){$("body").addClass("snap-js-loaded"),applyResponsiveVideo()})})}}});